# Proposal: TestClient Module

This document outlines the design and implementation plan for the `test-client` module, a Kotlin-based console application for managing test data and interacting with the AngularAI backend API.

## 1. Overview
The `test-client` is a CLI tool designed to facilitate data seeding, cleanup, and database inspection across different environments (local development, local Docker, and AWS).

## 2. Technical Stack
- **Language**: Kotlin 2.1.x
- **Build Tool**: Maven (as part of the multi-module project)
- **HTTP Client**: `java.net.http.HttpClient` (Standard Java 11+, no extra dependencies required).
- **CLI Framework**: Simple `main(args)` processing with a custom dispatcher for commands.
- **Serialization**: `Jackson` (standard in the project).

## 3. Module Structure
The module will be added to the root `pom.xml`:
```xml
<module>test-client</module>
```

Project structure:
```
test-client/
├── src/main/kotlin/ch/goodone/angularai/testclient/
│   ├── TestClientApp.kt       # Main entry point
│   ├── client/
│   │   └── ApiClient.kt       # Generic HTTP/REST client with Auth
│   ├── command/
│   │   ├── Command.kt         # Interface for commands
│   │   ├── LoadCommand.kt     # Loads sample/paging/custom data
│   │   ├── ClearCommand.kt    # Clears data with safety rules
│   │   └── DumpCommand.kt     # Dumps tables to JSON files
│   ├── model/                 # DTOs
│   └── service/               # Data generation logic
└── pom.xml
```

## 4. Features & CLI Commands

### 4.1. Load Sample Testdata
Individual methods to load sample data for different entities.
- `testclient load tasks [--user <login>]`
- `testclient load logs`
- `testclient load users`

**Implementation Details:**
- Uses `/api/tasks` (POST) for tasks.
- Uses `/api/admin/users` (POST) for user admin.
- `ActionLog` entries are usually generated by actions, but a specific "load logs" might simulate various actions to fill the database.

### 4.2. Extensive Dataset for Paging
Generates a large number of entries (e.g., 100+ tasks/logs) to test frontend paging.
- `testclient load paging-data [--count <number>]`

### 4.3. Dump Database Content
Dumps the content of each table to separate files (JSON format).
- `testclient dump`
- Files created: `dump_tasks.json`, `dump_users.json`, `dump_logs.json`.

**Implementation Details:**
- Uses GET endpoints (`/api/tasks`, `/api/admin/users`, `/api/admin/logs`).

### 4.4. Custom Datasets
Support for adding additional custom datasets via external JSON files.
- `testclient load custom --file <path_to_json>`

### 4.5. Clear Data
Removes all entries for specific entity types.
- `testclient clear tasks`
- `testclient clear logs`
- `testclient clear users [--keep-defaults]`

### 4.6. Special Case: User Admin Clearing
When clearing users, there is an option to protect the initial users (`admin` and `user`).
- By default, `admin` and `user` logins will NEVER be deleted if the `--keep-defaults` flag is used (or as a hardcoded safety rule).

## 5. Configuration & Environments
Supported environments:
1. **Local**: `http://localhost:8080`
2. **Docker**: `http://localhost:8080` (usually same as local if mapped)
3. **AWS**: `https://www.goodone.ch/api`

Environment can be selected via a flag or environment variable:
- `testclient --env local ...`
- `testclient --env aws ...`

## 6. Login & Security

### 6.1. Authentication
The client will use HTTP Basic Authentication (as supported by `SecurityConfig.java`).
- Credentials can be provided via environment variables (`TC_USERNAME`, `TC_PASSWORD`) or flags.

### 6.2. HTTPS Connection to AWS
To connect to `https://www.goodone.ch/api`:
1. **Certificate Trust**: Since it's a public domain with a valid certificate, standard Java/Kotlin HTTP clients should trust it automatically.
2. **Login Process**:
   - The tool must first "login" or simply send the `Authorization: Basic <base64>` header with every request.
   - For AWS, the base URL is `https://www.goodone.ch/api`.
   - Endpoint example: `POST https://www.goodone.ch/api/auth/login`.

**How to establish login with HTTPS connection:**
When using a tool like `curl` or Postman:
- **URL**: `https://www.goodone.ch/api/auth/login`
- **Method**: `POST`
- **Auth**: Basic Auth (Username: `admin`, Password: `...`)
- **Headers**: `Accept: application/json`

In the `test-client`:
- Use `HttpsURLConnection` or a modern client like `java.net.http.HttpClient` which supports TLS by default.
- Set the `Authorization` header: `"Basic " + Base64.getEncoder().encodeToString("user:pass".toByteArray())`.

## 7. Implementation Plan (Next Steps)
1. Create `test-client` module and `pom.xml`.
2. Implement basic API client with Auth support.
3. Implement `Main.kt` with command parsing.
4. Implement entity-specific services for Load/Clear/Dump operations.
5. Add documentation for usage.

## 8. Usage Instructions

### 8.1. Build
To build the test-client module:
```bash
mvn clean package -pl test-client -am
```

### 8.2. Run
The client can be run using the `exec-maven-plugin`:
```bash
mvn exec:java -pl test-client -Dexec.args="--env local load tasks"
```

Or by running the JAR directly (after build):
```bash
java -jar test-client/target/test-client-$NewVersion.jar --env aws load paging-data --count 100
```

### 8.3. Examples
- **Load Sample Data**: `testclient load tasks`
- **Paging Test**: `testclient load paging-data --count 150`
- **Clear Logs**: `testclient clear logs`
- **Safe User Cleanup**: `testclient clear users --keep-defaults`
- **Database Dump**: `testclient dump`

---
*Proposal created on 2026-01-09*
