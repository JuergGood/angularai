<div class="dashboard-loading" *ngIf="isLoading()">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  <p>{{ 'COMMON.LOADING' | translate }}</p>
</div>

<div class="dashboard-container" *ngIf="vm() as data">
  <!-- Summary Cards -->
  <div class="summary-grid" *ngIf="data && data.summary">
    <mat-card class="summary-card interactive-card tasks" routerLink="/tasks" data-cy="dashboard-open-tasks">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.OPEN_TASKS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.openTasks }}</div>
        <div class="stat-chip-set">
          <div class="custom-delta-chip tasks-chip">
            +{{ data.summary.openTasksDelta }} {{ 'DASHBOARD.TODAY' | translate }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card interactive-card users"
              [routerLink]="authService.isAdmin() ? '/user-admin' : '/profile'"
              data-cy="dashboard-active-users">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.ACTIVE_USERS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.activeUsers }}</div>
        <div class="stat-chip-set">
          <div class="custom-delta-chip users-chip">
            +{{ data.summary.activeUsersDelta }} {{ 'DASHBOARD.TODAY' | translate }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card interactive-card completed" routerLink="/tasks" data-cy="dashboard-completed-tasks">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.COMPLETED_TASKS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.completedTasks }}</div>
        <div class="stat-chip-set">
          <div class="custom-delta-chip completed-chip">
            +{{ data.summary.completedTasksDelta }} {{ 'DASHBOARD.TODAY' | translate }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card
      class="summary-card interactive-card logs"
      [class.disabled-card]="!authService.isAdmin()"
      [routerLink]="authService.isAdmin() ? '/logs' : undefined"
      [attr.aria-disabled]="!authService.isAdmin()"
      data-cy="dashboard-today-logs"
    >
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.TODAY_LOGS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.todayLogs }}</div>
        <div class="stat-chip-set">
          <div class="custom-delta-chip logs-chip">
            +{{ data.summary.todayLogsDelta }} {{ 'DASHBOARD.SINCE_1H' | translate }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="main-grid">
    <!-- Task Overview (primary) + Recent Activity (right panel on wide screens) -->
    <mat-card class="grid-item task-overview-card" *ngIf="data.taskDistribution">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'DASHBOARD.TASK_OVERVIEW' | translate }}</mat-card-title>
          <div class="card-header-actions">
            <button mat-stroked-button color="primary" routerLink="/tasks">
              {{ 'DASHBOARD.SHOW_ALL_TASKS' | translate }}
            </button>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="task-overview-layout">
          <div class="task-overview-chart">
            <div class="chart-container">
              <svg viewBox="0 0 36 36" class="circular-chart">
                <path class="circle-bg"
                      d="M18 2.0845
                    a 15.9155 15.9155 0 0 1 0 31.831
                    a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path *ngFor="let segment of getPieChartData(data.taskDistribution)"
                      class="circle"
                      [attr.stroke]="segment.color"
                      [attr.stroke-dasharray]="segment.value + ', 100'"
                      [attr.stroke-dashoffset]="-segment.offset"
                      d="M18 2.0845
                    a 15.9155 15.9155 0 0 1 0 31.831
                    a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <text x="18" y="18.5" class="percentage">{{ data.taskDistribution.total }}</text>
                <text x="18" y="24" class="label">{{ 'DASHBOARD.TOTAL_TASKS' | translate }}</text>
              </svg>
              <div class="chart-legend">
                <div class="legend-item"><span class="dot open"></span> {{ 'DASHBOARD.OPEN' | translate }}: {{ data.taskDistribution.open }}</div>
                <div class="legend-item"><span class="dot progress"></span> {{ 'DASHBOARD.IN_PROGRESS' | translate }}: {{ data.taskDistribution.inProgress }}</div>
                <div class="legend-item"><span class="dot completed"></span> {{ 'DASHBOARD.COMPLETED' | translate }}: {{ data.taskDistribution.completed }}</div>
                <div class="legend-item"><span class="dot closed"></span> {{ 'DASHBOARD.CLOSED' | translate }}: {{ data.taskDistribution.closed }}</div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="grid-item">
      <mat-card-header>
        <!-- <div class="task-overview-activity">-->
        <div class="subpanel-header">
          <div class="subpanel-title">{{ 'DASHBOARD.RECENT_ACTIVITY' | translate }}</div>
          <div class="subpanel-actions-row">
            <div class="activity-filter-wrapper">
              <mat-icon class="filter-icon">search</mat-icon>
              <input
                class="filter-input"
                placeholder="Filter activity..."
                [value]="activityFilter()"
                (input)="activityFilter.set(($any($event.target).value || '').toString())"
              />
              @if (activityFilter().length > 0) {
                <button mat-icon-button class="clear-btn" (click)="clearActivityFilter()">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </div>
            <button mat-stroked-button color="primary" routerLink="/logs" *ngIf="authService.isAdmin()">
              {{ 'DASHBOARD.SHOW_ALL_LOGS' | translate }}
            </button>
          </div>
        </div>

        <!--     </div>-->
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data.recentActivityFiltered" class="full-width-table compact-table"
               [trackBy]="trackById">
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.TIME' | translate }}</th>
            <td mat-cell *matCellDef="let log">
              <span class="muted">{{ log.timestampLabel }}</span>
            </td>
          </ng-container>
          <ng-container matColumnDef="login">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.USER' | translate }}</th>
            <td mat-cell *matCellDef="let log" style="font-weight: 500;"> {{ log.login }}</td>
          </ng-container>
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.ACTION' | translate }}</th>
            <td mat-cell *matCellDef="let log">
              <mat-chip class="action-chip" [ngClass]="log.actionClass">{{ log.actionLabel }}</mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="recentActivityColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: recentActivityColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!--<div class="secondary-grid">-->
    <!-- User Admin Preview -->
    <mat-card class="grid-item">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'ADMIN.TITLE' | translate }}</mat-card-title>
          <button mat-stroked-button color="primary" routerLink="/user-admin" *ngIf="authService.isAdmin()">
            {{ 'DASHBOARD.SHOW_ALL_USERS' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data.recentUsers" class="full-width-table" [trackBy]="trackById">
          <ng-container matColumnDef="login">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.LOGIN' | translate }}</th>
            <td mat-cell *matCellDef="let user" style="font-weight: 500;"> {{ user.login }}</td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.EMAIL' | translate }}</th>
            <td mat-cell *matCellDef="let user"> {{ user.email }}</td>
          </ng-container>
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.ROLE' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip class="role-chip" [ngClass]="user.roleClass">{{ user.roleLabel }}</mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="recentUsersColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: recentUsersColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- Priority Tasks -->
    <mat-card class="grid-item">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'DASHBOARD.PRIORITY_TASKS' | translate }}</mat-card-title>
          <button mat-stroked-button color="primary"
                  routerLink="/tasks">{{ 'DASHBOARD.SHOW_ALL_TASKS' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="priority-list" *ngIf="data.priorityTasks.length > 0; else noPriorityTasks">
          @for (task of data.priorityTasks; track task.id) {
            <div class="priority-row" routerLink="/tasks">
              <div class="priority-left">
                <mat-icon class="priority-icon" color="warn">priority_high</mat-icon>
                <div>
                  <div class="priority-title">{{ task.title }}</div>
                  <div class="priority-sub muted">{{ 'DASHBOARD.DUE' | translate }}: {{ task.dueDate }}</div>
                </div>
              </div>
              <mat-chip class="due-chip" [ngClass]="task.dueChip.tone">
                {{ task.dueChip.label }}
              </mat-chip>
            </div>
          }
        </div>

        <ng-template #noPriorityTasks>
          <div class="empty-msg">{{ 'DASHBOARD.NO_PRIORITY_TASKS' | translate }}</div>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>
  <!-- </div>-->
</div>
