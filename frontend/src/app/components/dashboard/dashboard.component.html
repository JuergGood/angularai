<div class="dashboard-loading" *ngIf="isLoading()">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  <p>{{ 'COMMON.LOADING' | translate }}</p>
</div>

<div class="dashboard-container" *ngIf="dashboardData() as data">
  <!-- Summary Cards -->
  <div class="summary-grid">
    <mat-card class="summary-card interactive-card" routerLink="/tasks">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.OPEN_TASKS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.openTasks }}</div>
        <div class="stat-delta positive">+{{ data.summary.openTasksDelta }} {{ 'DASHBOARD.TODAY' | translate }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card interactive-card" [routerLink]="authService.isAdmin() ? '/user-admin' : '/profile'">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.ACTIVE_USERS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.activeUsers }}</div>
        <div class="stat-delta positive">+{{ data.summary.activeUsersDelta }} {{ 'DASHBOARD.TODAY' | translate }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card interactive-card" routerLink="/tasks">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.COMPLETED_TASKS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.completedTasks }}</div>
        <div class="stat-delta positive">+{{ data.summary.completedTasksDelta }} {{ 'DASHBOARD.TODAY' | translate }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card interactive-card" [routerLink]="authService.isAdmin() ? '/logs' : null">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.TODAY_LOGS' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ data.summary.todayLogs }}</div>
        <div class="stat-delta positive">+{{ data.summary.todayLogsDelta }} {{ 'DASHBOARD.SINCE_1H' | translate }}</div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="main-grid">
    <!-- Task Overview -->
    <mat-card class="grid-item">
      <mat-card-header>
        <mat-card-title>{{ 'DASHBOARD.TASK_OVERVIEW' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <svg viewBox="0 0 36 36" class="circular-chart">
            <path class="circle-bg"
              d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
            />
            <path *ngFor="let segment of getPieChartData(data.taskDistribution)"
              class="circle"
              [attr.stroke]="segment.color"
              [attr.stroke-dasharray]="segment.value + ', 100'"
              [attr.stroke-dashoffset]="-segment.offset"
              d="M18 2.0845
                a 15.9155 15.9155 0 0 1 0 31.831
                a 15.9155 15.9155 0 0 1 0 -31.831"
            />
            <text x="18" y="18.5" class="percentage">{{ data.taskDistribution.total }}</text>
            <text x="18" y="24" class="label">{{ 'DASHBOARD.TOTAL_TASKS' | translate }}</text>
          </svg>
          <div class="chart-legend">
            <div><span class="dot open"></span> {{ 'DASHBOARD.OPEN' | translate }}: {{ data.taskDistribution.open }}</div>
            <div><span class="dot progress"></span> {{ 'DASHBOARD.IN_PROGRESS' | translate }}: {{ data.taskDistribution.inProgress }}</div>
            <div><span class="dot completed"></span> {{ 'DASHBOARD.COMPLETED' | translate }}: {{ data.taskDistribution.completed }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recent Activity -->
    <mat-card class="grid-item">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'DASHBOARD.RECENT_ACTIVITY' | translate }}</mat-card-title>
          <button mat-button color="primary" routerLink="/logs" *ngIf="authService.isAdmin()">
            {{ 'DASHBOARD.SHOW_ALL_LOGS' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data.recentActivity" class="full-width-table">
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.TIME' | translate }} </th>
            <td mat-cell *matCellDef="let log"> {{ log.timestamp }} </td>
          </ng-container>
          <ng-container matColumnDef="login">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.USER' | translate }} </th>
            <td mat-cell *matCellDef="let log"> {{ log.login }} </td>
          </ng-container>
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef> {{ 'DASHBOARD.ACTION' | translate }} </th>
            <td mat-cell *matCellDef="let log"> {{ log.action }} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="recentActivityColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: recentActivityColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- Priority Tasks -->
    <mat-card class="grid-item">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'DASHBOARD.PRIORITY_TASKS' | translate }}</mat-card-title>
          <button mat-button color="primary" routerLink="/tasks">
            {{ 'DASHBOARD.SHOW_ALL_TASKS' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <mat-list>
          <mat-list-item *ngFor="let task of data.priorityTasks" class="interactive-item" routerLink="/tasks">
            <mat-icon matListItemIcon color="warn">priority_high</mat-icon>
            <div matListItemTitle>{{ task.title }}</div>
            <div matListItemLine>{{ 'DASHBOARD.DUE' | translate }}: {{ task.dueDate }}</div>
          </mat-list-item>
          <div *ngIf="data.priorityTasks.length === 0" class="empty-msg">{{ 'DASHBOARD.NO_PRIORITY_TASKS' | translate }}</div>
        </mat-list>
      </mat-card-content>
    </mat-card>

    <!-- User Admin Preview -->
    <mat-card class="grid-item full-row">
      <mat-card-header>
        <div class="card-header-container">
          <mat-card-title>{{ 'ADMIN.TITLE' | translate }}</mat-card-title>
          <button mat-button color="primary" routerLink="/user-admin" *ngIf="authService.isAdmin()">
            {{ 'DASHBOARD.SHOW_ALL_USERS' | translate }}
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data.recentUsers" class="full-width-table">
          <ng-container matColumnDef="login">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.LOGIN' | translate }} </th>
            <td mat-cell *matCellDef="let log"> {{ log.login }} </td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.EMAIL' | translate }} </th>
            <td mat-cell *matCellDef="let user"> {{ user.email }} </td>
          </ng-container>
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef> {{ 'ADMIN.ROLE' | translate }} </th>
            <td mat-cell *matCellDef="let user"> {{ user.role }} </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="recentUsersColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: recentUsersColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>
</div>
