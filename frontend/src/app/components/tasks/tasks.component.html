<div class="tasks-container">
  <div class="page-toolbar">
    <div class="left">
      <h2 class="page-title">{{ 'TASKS.TITLE' | translate }}</h2>
    </div>

    <div class="right">
      <button mat-icon-button (click)="toggleViewMode()" [title]="'TASKS.VIEW_MODE' | translate">
        <mat-icon>{{ viewMode === 'COMFORTABLE' ? 'view_headline' : 'view_stream' }}</mat-icon>
      </button>
      @if (!showForm) {
        <button mat-flat-button color="primary" class="add-task-btn" (click)="showAddTaskForm()">
          <mat-icon>add</mat-icon>
          {{ 'TASKS.ADD_TASK' | translate }}
        </button>
      }
      <button mat-stroked-button class="reset-sort-btn" (click)="resetSorting()" [title]="'TASKS.SORT_DESC' | translate">
        <mat-icon>sort</mat-icon>
        {{ 'TASKS.RESET_SORT' | translate }}
      </button>
    </div>
  </div>

  <div class="quick-add-container">
    <app-quick-add-task></app-quick-add-task>
  </div>

  <app-task-filter-chips [activeFilter]="activeFilter" (filterChange)="onFilterChange($event)"></app-task-filter-chips>

  @if (filteredTasks.length > 0) {
    <div class="selection-toolbar">
      <div class="selection-box-header">
        <mat-checkbox (change)="toggleSelectAll($event.checked)"
                      [checked]="isAllSelected()"
                      [indeterminate]="isPartiallySelected()">
        </mat-checkbox>
      </div>
      <span class="selection-label">{{ 'TASKS.SELECT_ALL' | translate }}</span>
    </div>
  }

  @if (selectedTaskIds().size > 0) {
    <div class="bulk-actions-bar">
      <span>{{ selectedTaskIds().size }} {{ 'TASKS.SELECTED' | translate }}</span>
      <button mat-button [matMenuTriggerFor]="bulkStatusMenu">
        <mat-icon>update</mat-icon>
        {{ 'TASKS.BULK_STATUS' | translate }}
      </button>
      <mat-menu #bulkStatusMenu="matMenu">
        @for (s of statuses; track s) {
          <button mat-menu-item (click)="bulkUpdateStatus(s)">{{ 'TASKS.STATUS.' + s | translate }}</button>
        }
      </mat-menu>

      <button mat-button [matMenuTriggerFor]="bulkPrioMenu">
        <mat-icon>priority_high</mat-icon>
        {{ 'TASKS.BULK_PRIORITY' | translate }}
      </button>
      <mat-menu #bulkPrioMenu="matMenu">
        @for (p of priorities; track p) {
          <button mat-menu-item (click)="bulkUpdatePriority(p)">{{ 'TASKS.PRIORITY.' + p | translate }}</button>
        }
      </mat-menu>

      <button mat-button color="warn" (click)="bulkDelete()">
        <mat-icon>delete</mat-icon>
        {{ 'ADMIN.DELETE' | translate }}
      </button>

      <span style="flex: 1"></span>
      <button mat-icon-button (click)="selectedTaskIds.set(newSet())">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  @if (showForm) {
    <app-task-form
      [task]="currentTask"
      [isEditing]="!!editingTask"
      (save)="onSubmit()"
      (cancel)="cancelEdit()"
    ></app-task-form>
  }

  <div class="tasks-list" cdkDropList (cdkDropListDropped)="drop($event)" [cdkDropListDisabled]="activeFilter !== 'ALL'">
    @for (task of filteredTasks; track task.id) {
      <app-task-item
        cdkDrag
        [task]="task"
        [viewMode]="viewMode"
        [isSelected]="isTaskSelected(task.id)"
        [isActiveActions]="activeActionsTaskId === task.id"
        [isEditingTitle]="editingTitleId === task.id"
        [formattedDate]="formatDate(task.dueDate)"
        (toggleSelection)="toggleTaskSelection(task.id)"
        (toggleDone)="toggleTaskDone(task)"
        (edit)="editTask(task)"
        (delete)="deleteTask(task)"
        (startEditTitle)="startEditTitle(task)"
        (saveTitle)="saveTitle(task, $event)"
        (setPriority)="setPriority(task, $event)"
        (cycleStatus)="cycleStatus(task, $event)"
        (toggleActions)="toggleActions($event, task)"
      ></app-task-item>
    } @empty {
      <p class="empty-message">{{ 'TASKS.EMPTY' | translate }}</p>
    }
  </div>

  <app-completed-tasks-section [tasks]="completedRecently()"></app-completed-tasks-section>
</div>
