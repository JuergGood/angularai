<div class="tasks-container">
  <div class="page-toolbar">
    <div class="left">
      <h2 class="page-title">{{ 'TASKS.TITLE' | translate }}</h2>
    </div>

    <div class="right">
      <button mat-icon-button (click)="toggleViewMode()" [title]="'TASKS.VIEW_MODE' | translate">
        <mat-icon>{{ viewMode === 'COMFORTABLE' ? 'view_headline' : 'view_stream' }}</mat-icon>
      </button>
      <button mat-flat-button color="primary" class="add-task-btn" (click)="showAddTaskForm()" *ngIf="!showForm">
        <mat-icon>add</mat-icon>
        {{ 'TASKS.ADD_TASK' | translate }}
      </button>
      <button mat-stroked-button class="reset-sort-btn" (click)="resetSorting()" [title]="'TASKS.SORT_DESC' | translate">
        <mat-icon>sort</mat-icon>
        {{ 'TASKS.RESET_SORT' | translate }}
      </button>
    </div>
  </div>

  <div class="quick-add-container">
    <app-quick-add-task></app-quick-add-task>
  </div>

  <app-task-filter-chips [activeFilter]="activeFilter" (filterChange)="onFilterChange($event)"></app-task-filter-chips>

  <div class="selection-toolbar" *ngIf="filteredTasks.length > 0">
    <mat-checkbox (change)="toggleSelectAll($event.checked)"
                  [checked]="isAllSelected()"
                  [indeterminate]="isPartiallySelected()">
      {{ 'TASKS.SELECT_ALL' | translate }}
    </mat-checkbox>
  </div>

  @if (selectedTaskIds().size > 0) {
    <div class="bulk-actions-bar">
      <span>{{ selectedTaskIds().size }} {{ 'TASKS.SELECTED' | translate }}</span>
      <button mat-button [matMenuTriggerFor]="bulkStatusMenu">
        <mat-icon>update</mat-icon>
        {{ 'TASKS.BULK_STATUS' | translate }}
      </button>
      <mat-menu #bulkStatusMenu="matMenu">
        @for (s of statuses; track s) {
          <button mat-menu-item (click)="bulkUpdateStatus(s)">{{ 'TASKS.STATUS.' + s | translate }}</button>
        }
      </mat-menu>

      <button mat-button [matMenuTriggerFor]="bulkPrioMenu">
        <mat-icon>priority_high</mat-icon>
        {{ 'TASKS.BULK_PRIORITY' | translate }}
      </button>
      <mat-menu #bulkPrioMenu="matMenu">
        @for (p of priorities; track p) {
          <button mat-menu-item (click)="bulkUpdatePriority(p)">{{ 'TASKS.PRIORITY.' + p | translate }}</button>
        }
      </mat-menu>

      <button mat-button color="warn" (click)="bulkDelete()">
        <mat-icon>delete</mat-icon>
        {{ 'ADMIN.DELETE' | translate }}
      </button>

      <span style="flex: 1"></span>
      <button mat-icon-button (click)="selectedTaskIds.set(newSet())">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  @if (showForm) {
    <mat-card class="add-task-card">
      <mat-card-header>
        <mat-card-title>{{ (editingTask ? 'TASKS.EDIT_TASK' : 'TASKS.ADD_TASK') | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form (ngSubmit)="onSubmit()" #taskForm="ngForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'TASKS.FORM.TITLE' | translate }}</mat-label>
            <input matInput name="title" [(ngModel)]="currentTask.title" required placeholder="{{ 'TASKS.FORM.TITLE_PH' | translate }}">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'TASKS.FORM.DESCRIPTION' | translate }}</mat-label>
            <textarea matInput name="description" [(ngModel)]="currentTask.description" required rows="3"></textarea>
          </mat-form-field>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'TASKS.FORM.DUE_DATE' | translate }}</mat-label>
              <input matInput [matDatepicker]="picker" name="dueDate" [(ngModel)]="currentTask.dueDate">
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'TASKS.FORM.PRIORITY' | translate }}</mat-label>
              <mat-select name="priority" [(ngModel)]="currentTask.priority" required>
                @for (p of priorities; track p) {
                  <mat-option [value]="p">{{ 'TASKS.PRIORITY.' + p | translate }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'TASKS.FORM.STATUS' | translate }}</mat-label>
              <mat-select name="status" [(ngModel)]="currentTask.status" required>
                @for (s of statuses; track s) {
                  <mat-option [value]="s">{{ 'TASKS.STATUS.' + s | translate }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-flat-button color="primary" type="submit" [disabled]="!taskForm.form.valid" class="submit-btn">
              {{ (editingTask ? 'TASKS.UPDATE_TASK' : 'TASKS.ADD_TASK') | translate }}
            </button>
            <button mat-button type="button" (click)="cancelEdit()">{{ 'TASKS.CANCEL' | translate }}</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }

  <div class="tasks-list" cdkDropList (cdkDropListDropped)="drop($event)" [cdkDropListDisabled]="activeFilter !== 'ALL'">
    @for (task of filteredTasks; track task.id) {
      <mat-card class="task-card" cdkDrag>
        <div class="task-row" [class.compact]="viewMode === 'COMPACT'">
          <mat-checkbox [checked]="isTaskSelected(task.id)" (change)="toggleTaskSelection(task.id)"></mat-checkbox>

          <button mat-icon-button (click)="toggleTaskDone(task)" class="task-status-btn" [class.done]="task.status === 'DONE'">
            <mat-icon>{{ task.status === 'DONE' ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
          </button>

          <div class="task-title-container" (dblclick)="startEditTitle(task)">
            @if (editingTitleId === task.id) {
              <input class="task-title-input" [value]="task.title" #titleInput (keydown.enter)="saveTitle(task, titleInput.value)" (blur)="saveTitle(task, titleInput.value)" autoFocus>
            } @else {
              <span class="task-title-text" [class.done]="task.status === 'DONE'">{{ task.title }}</span>
            }
          </div>

          <div class="task-meta-info">
            <span class="due-date-info" [class.overdue]="isOverdue(task.dueDate)">
              {{ formatDate(task.dueDate) }}
            </span>

            <span class="priority-badge" [class]="'priority-' + task.priority.toLowerCase()" [matMenuTriggerFor]="prioMenu">
              {{ 'TASKS.PRIORITY.' + task.priority | translate }}
            </span>
            <mat-menu #prioMenu="matMenu">
              @for (p of priorities; track p) {
                <button mat-menu-item (click)="setPriority(task, p)">{{ 'TASKS.PRIORITY.' + p | translate }}</button>
              }
            </mat-menu>

            <span class="status-pill" [class]="'status-' + task.status.toLowerCase()" (click)="cycleStatus(task, $event)">
              {{ 'TASKS.STATUS.' + task.status | translate }}
            </span>
          </div>

          <div class="task-actions">
            <button mat-icon-button (click)="editTask(task)" [title]="'TASKS.EDIT_TASK' | translate">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteTask(task)" [title]="'ADMIN.DELETE' | translate">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </mat-card>
    } @empty {
      <p class="empty-message">{{ 'TASKS.EMPTY' | translate }}</p>
    }
  </div>

  <app-completed-tasks-section [tasks]="completedRecently()"></app-completed-tasks-section>
</div>
