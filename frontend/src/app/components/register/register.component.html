<div class="register-page">
  <mat-card class="main-card register-card">
    <mat-card-header>
      <mat-card-title>{{ 'ADMIN.CREATE_USER' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content style="padding: 24px;">
      <!-- CR-REG-02: reactive form -->
      <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
        <p class="verification-hint">
          <mat-icon inline="true">info</mat-icon>
          <span>{{ 'REGISTER.VERIFICATION_HINT' | translate }}</span>
        </p>
        <div class="form-grid full-width-name">
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'ADMIN.FULL_NAME' | translate }}</mat-label>
            <input matInput formControlName="fullName">
            <mat-hint align="start">Vorname Nachname</mat-hint>
            @if (showError('fullName')) {
              @if (registerForm.get('fullName')?.hasError('required')) {
                <mat-error>{{ 'ADMIN.ERROR_REQUIRED' | translate }}</mat-error>
              } @else if (registerForm.get('fullName')?.hasError('nameFormat')) {
                <mat-error>{{ 'ADMIN.ERROR_NAME_FORMAT' | translate }}</mat-error>
              }
            }
          </mat-form-field>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'ADMIN.LOGIN' | translate }}</mat-label>
            <input matInput formControlName="login" autocomplete="off">
            @if (showError('login')) {
              @if (registerForm.get('login')?.hasError('required')) {
                <mat-error>{{ 'ADMIN.ERROR_REQUIRED' | translate }}</mat-error>
              } @else if (registerForm.get('login')?.hasError('noSpaces')) {
                <mat-error>{{ 'ADMIN.ERROR_LOGIN_SPACES' | translate }}</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'ADMIN.EMAIL' | translate }}</mat-label>
            <input matInput type="email" formControlName="email">
            <mat-hint align="start">e.g. name&#64;example.com</mat-hint>
            @if (showError('email')) {
              @if (registerForm.get('email')?.hasError('required')) {
                <mat-error>{{ 'ADMIN.ERROR_REQUIRED' | translate }}</mat-error>
              } @else if (registerForm.get('email')?.hasError('email')) {
                <mat-error>{{ 'ADMIN.ERROR_EMAIL' | translate }}</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="password-field">
            <mat-label>{{ 'ADMIN.PASSWORD' | translate }}</mat-label>
            <!-- CR-REG-03: show/hide toggle -->
            <input matInput [type]="passwordVisible ? 'text' : 'password'" formControlName="password" autocomplete="new-password" (input)="onPasswordChange($any($event.target).value)">

            <button mat-icon-button matSuffix (click)="passwordVisible = !passwordVisible" type="button" [attr.aria-label]="'Toggle password visibility'">
              <mat-icon>{{passwordVisible ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>

            <mat-hint align="start">{{ 'ADMIN.PASSWORD_HINT' | translate }}</mat-hint>

            <!-- CR-REG-03: strength indicator logic moved to hint align="end" -->
            @if (passwordStrength && registerForm.get('password')?.value) {
              <mat-hint align="end" [class]="'strength-text-' + passwordStrength">
                <mat-icon inline="true" [class]="'strength-' + passwordStrength">
                  {{ passwordStrength === 'strong' ? 'verified_user' : (passwordStrength === 'medium' ? 'security' : 'error_outline') }}
                </mat-icon>
                {{ 'ADMIN.STRENGTH.' + (passwordStrength | uppercase) | translate }}
              </mat-hint>
            }

            @if (showError('password')) {
              @if (registerForm.get('password')?.hasError('required')) {
                <mat-error>{{ 'ADMIN.ERROR_REQUIRED' | translate }}</mat-error>
              } @else if (registerForm.get('password')?.hasError('passwordStrength')) {
                <mat-error>{{ 'ADMIN.ERROR_PASSWORD_STRENGTH' | translate }}</mat-error>
              }
            }
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'ADMIN.CONFIRM_PASSWORD' | translate }}</mat-label>
            <!-- CR-REG-03: show/hide toggle -->
            <input matInput [type]="confirmPasswordVisible ? 'text' : 'password'" formControlName="confirmPassword" autocomplete="new-password">
            <button mat-icon-button matSuffix (click)="confirmPasswordVisible = !confirmPasswordVisible" type="button" [attr.aria-label]="'Toggle password visibility'">
              <mat-icon>{{confirmPasswordVisible ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>

            <mat-hint align="start">{{ 'ADMIN.CONFIRM_PASSWORD' | translate }}</mat-hint>

            @if (showError('confirmPassword')) {
              @if (registerForm.get('confirmPassword')?.hasError('required')) {
                <mat-error>{{ 'ADMIN.ERROR_REQUIRED' | translate }}</mat-error>
              } @else if (registerForm.errors?.['passwordMismatch'] || registerForm.get('confirmPassword')?.hasError('passwordMismatch')) {
                <mat-error>{{ 'ADMIN.ERROR_PASSWORD_MATCH' | translate }}</mat-error>
              }
            }
          </mat-form-field>
        </div>

        <!-- CR-REG-04: reCAPTCHA UX -->
        <div class="recaptcha-wrapper" [class.hidden]="recaptchaMode === 'score' && recaptchaStatus !== 'verifying'">
          <div id="recaptcha-container"></div>

          @if (recaptchaMode === 'score' && recaptchaStatus === 'verifying') {
             <div class="recaptcha-status feedback-hint">
               <mat-spinner diameter="20"></mat-spinner>
               <span>{{ 'REGISTER.VERIFYING_RECAPTCHA' | translate }}</span>
             </div>
          }
        </div>

        @if (recaptchaStatus === 'error') {
          <p class="error feedback-error">{{ 'REGISTER.RECAPTCHA_FAILED' | translate }}</p>
        }

        <div class="form-actions register-actions">
          <a mat-button routerLink="/login">{{ 'NAV.LOGIN' | translate }}</a>

          <!-- CR-REG-06: loading state and spinner -->
          <button mat-flat-button color="primary" type="submit" [disabled]="registerForm.invalid || isSubmitting || (recaptchaMode === 'visible' && recaptchaStatus !== 'verified')" id="register-btn" style="min-width: 140px;">
            @if (isSubmitting) {
              <mat-spinner diameter="24" color="accent"></mat-spinner>
            } @else {
              {{ 'ADMIN.ADD_USER' | translate }}
            }
          </button>
        </div>

        @if (error) {
          <p class="error">{{ error | translate }}</p>
        }
      </form>
    </mat-card-content>
  </mat-card>
</div>
